#!/bin/sh

case "$1" in
start)
	echo "Loading ldd modules"
	modprobe hello
	modprobe faulty
	modprobe scull
	
	# Load scull devices (logic from scull_load)
	major=$(awk "\$2=="scull" {print \$1}" /proc/devices)
	if [ -n "$major" ]; then
		rm -f /dev/scull[0-3]
		mknod /dev/scull0 c $major 0
		mknod /dev/scull1 c $major 1
		mknod /dev/scull2 c $major 2
		mknod /dev/scull3 c $major 3
		chmod 666 /dev/scull[0-3]
	fi
	
	# Load faulty device
	major=$(awk "\$2=="faulty" {print \$1}" /proc/devices)
	if [ -n "$major" ]; then
		rm -f /dev/faulty
		mknod /dev/faulty c $major 0
		chmod 666 /dev/faulty
	fi
	;;
stop)
	echo "Unloading ldd modules"
	rmmod hello
	rmmod faulty
	rmmod scull
	rm -f /dev/scull[0-3]
	rm -f /dev/faulty
	;;
*)
	echo "Usage: $0 {start|stop}"
	exit 1
esac

exit 0
